<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Alex Hubbard" />

<meta name="date" content="2025-10-17" />

<title>Kim Filter for State Space Models</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Kim Filter for State Space Models</h1>
<h4 class="author">Alex Hubbard</h4>
<h4 class="date">2025-10-17</h4>



<p><code>kimfilter</code> is an <code>Rcpp</code> implementation of the
multivariate Kim filter, which combines the Kalman and Hamilton filters
for state probability inference. The filter is designed for state space
models and can handle missing values and exogenous data in the
observation and state equations.</p>
<p>The Kalman filter is a method to compute the optimal estimator of the
unobserved state vector in a time series, while the Hamilton filter is a
Markov switching model designed to provide the probability of being in
one of a set of potential states. The Kim filter combines these two
filters for state space models.</p>
<div id="the-state-space-model" class="section level1">
<h1>The State Space Model</h1>
<p>The state space model is written as <span class="math display">\[
Y_t = A_{s_t} + H_{s_t} \beta_t + B^o_{s_t} X^o_t + e_t, e_t \sim N(0,
R_{s_t}) \\
\beta_t = D_{s_t} + F_{s_t} \beta_{t-1} + B^s_{s_t} X^s_t  + u_t, u_t
\sim N(0, Q_{s_t})
\]</span> where the first equation is the observation equation and the
second equation is the state equation. <span class="math inline">\(A_{s_t}\)</span> is the observation intercept
matrix, <span class="math inline">\(H_{s_t}\)</span> is the observation
matrix, <span class="math inline">\(X^o_t\)</span> is optional exogenous
data in the observation equation, <span class="math inline">\(e_t \sim
N(0, R_{s_t})\)</span> is the observation error, and <span class="math inline">\(R_{s_t}\)</span> is the observation
error-covariance matrix. <span class="math inline">\(\beta_t\)</span> is
the vector of the state components <span class="math inline">\(D_{s_t}\)</span> is state intercept matrix, <span class="math inline">\(F_{s_t}\)</span> is the transition matrix, <span class="math inline">\(X^s_t\)</span> is optional exogenous data in the
state equation, <span class="math inline">\(v_t \sim N(0,
Q_{s_t})\)</span> is the state error, and <span class="math inline">\(Q_{s_t}\)</span> is the state error-covariance
matrix.</p>
<p>The subscript <span class="math inline">\(s_t\)</span> denotes that
some of the parameters in in the matrices can be time varying depending
on the state <span class="math inline">\(s\)</span> at time <span class="math inline">\(t\)</span>. The number of states <span class="math inline">\(S\)</span> are typically limited to a small number
like 2 or 3 for tractability, but can include many.</p>
<p>The transition probabilities are given by</p>
<p><span class="math display">\[
p = \begin{bmatrix}
p_{11} &amp; p_{21} &amp; \ldots &amp; p_{S1} \\
p_{12} &amp; p_{22} &amp; \ldots &amp; p_{S2} \\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
p_{1S} &amp; p_{2S} &amp; \ldots &amp; p_{SS}
\end{bmatrix}
\]</span></p>
<p>where <span class="math inline">\(p_{ij} = Pr[s_t = j|s_{t-1} =
i]\)</span> with <span class="math inline">\(\sum_{j=1]^S p_{ij} =
1\)</span> for all <span class="math inline">\(i\)</span> (i.e. the
columns sum to 1).</p>
<p>With the basic Kalman filter, the goal is forecast the state vector
<span class="math inline">\(\beta_t\)</span> based on information up to
time <span class="math inline">\(t-1\)</span>, which is denoted <span class="math inline">\(\beta_{t|t-1}\)</span>. However, in the Markov
switching case, the goal is form a forecast of <span class="math inline">\(\beta_t\)</span> based on information up to time
<span class="math inline">\(t-1\)</span> and also conditional on the
<span class="math inline">\(s_t\)</span> being value <span class="math inline">\(j\)</span> and <span class="math inline">\(s_{t-1}\)</span> being value <span class="math inline">\(i\)</span> denoted <span class="math inline">\(\beta_{t|t-1}^{(i,j)}\)</span>.</p>
<p>The Kim filter calculates <span class="math inline">\(S^2\)</span>
such forecasts at each time <span class="math inline">\(t\)</span>, so
is much more computationally intensive than the basic Kalman filter. The
algorithm follows in the same forward two-step procedure of the Kalman
filter, where the “forwardness” of the filter means that it uses only
data up to time <span class="math inline">\(t\)</span> to make an
inference on the unobserved components at time <span class="math inline">\(t\)</span> and does peak into the future to make
that inference.</p>
<div id="prediction-stage" class="section level2">
<h2>Prediction Stage</h2>
<p>The first stage is the prediction stage, which makes predictions of
the state components based on information up to time <span class="math inline">\(t-1\)</span> and all the possible outcomes of
<span class="math inline">\(s_t\)</span> denoted by <span class="math inline">\(j\)</span> and the outcome of <span class="math inline">\(s_{t-1}\)</span> denoted by <span class="math inline">\(i\)</span>. This stage is made up of four
equations, the first is the prediction of the state components based on
its time series properties</p>
<p><span class="math display">\[
\beta_{t|t-1}^{(i,j)} = D_j + F_j \beta_{t-1|t-1}^i + B^o_j X^o_t
\]</span> Second, is the prediction of the covariance matrix of the
state components</p>
<p><span class="math display">\[
P_{t|t-1}^{(i,j)} = F_j P_{t-1|t-1}^i F_j^{\prime} + Q_j
\]</span> Third, is the prediction error of the time series of
interest</p>
<p><span class="math display">\[
\eta_{t|t-1}^{(i,j)} = Y_t - (A_j + H_j \beta_{t|t-1}^{(i,j)} + B^o_j
X^o_t)
\]</span> And finally, we have the variance of the prediction error</p>
<p><span class="math display">\[
f_{t|t-1}^{(i,j)} = H_j P_{t|t-1}^{(i,j)} H_j^{\prime} + R_j
\]</span> ## Updating State</p>
<p>The second state is the updating stage, which makes predictions on
all information up to time <span class="math inline">\(t\)</span>. It
consists of three equations. The first equation is the prediction of the
state components based on the full information set</p>
<p><span class="math display">\[
\beta_{t|t}^{(i,j)} = \beta_{t|t-1}^{(i,j)} + K_t^{(i,j)}
\eta_{t|t-1}^{(i,j)}
\]</span> where <span class="math inline">\(K_{t}^{(i,j)}\)</span> is
the Kalman gain, which determines the optimal weight to give new
information in making predictions about <span class="math inline">\(\beta_t\)</span> and is the second equation</p>
<p><span class="math display">\[
K_t^{(i,j)} = P_{t|t-1}^{(i,j)} H_j^{\prime} \left( f_{t|t-1}^{(i,j)}
\right)^{-1}
\]</span> The last equation is the updating of the covariance matrix of
the state components</p>
<p><span class="math display">\[
P_{t|t}^{(i,j)} = P_{t|t-1}^{(i,j)} - K_t^{(i,j)} H_j^{\prime}
P_{t|t-1}^{(i,j)}
\]</span> The seven equations above, make up the full Kalman filter
routine for a given pair of state outcomes <span class="math inline">\(s_t = j\)</span> and <span class="math inline">\(s_{t-1} = i\)</span>. If <span class="math inline">\(Y_t\)</span> is missing for any observation,
then</p>
<p><span class="math display">\[
B_{t|t}^{(i,j)} = B_{t|t-1}^{(i,j)} \\
P_{t|t}^{(i,j)} = P_{t|t-1}^{(i,j)} \\
K_t^{(i,j)} = 0 \\
f_{t|t-1}^{(i,j)} = \infty
\]</span> However, the key to the Kim filter is to collapse the terms
into best estimate of <span class="math inline">\(s_t\)</span> as so</p>
<p><span class="math display">\[
\beta_{t|t}^j = \frac{\sum_{i=1}^S Pr[s_{t-1} = i, s_t = j|t]
\beta_{t|t}^{(i,j)}}{Pr[s_t = j|t]}
\]</span></p>
<p>and</p>
<p><span class="math display">\[
P_{t|t}^j = \frac{Pr[s_{t-1} = i, s_t = j|t]\left( \beta_{t|t}^j -
\beta_{t|t}^{(i,j)} \right)\left( \beta_{t|t}^j - \beta_{t|t}^{(i,j)}
\right)^{\prime}}{Pr[s_t = j|t]}
\]</span> Note, however that these collapsed terms involve
approximations. This is because <span class="math inline">\(\beta_{t}\)</span> conditional on information up
to time <span class="math inline">\(t\)</span>, <span class="math inline">\(s_t\)</span>, and <span class="math inline">\(s_{t-1}\)</span> is a mixture of normals. However,
the algorithm is still considered to be making reasonable inferences
about <span class="math inline">\(\beta_t\)</span>.</p>
</div>
<div id="probability-stage" class="section level2">
<h2>Probability Stage</h2>
<p>The Kim filter adds an additional stage to the Kalman filter. This
stage makes inferences about the probability terms that show up in the
above equations.</p>
<p>The first step in this stage is to calculate</p>
<p><span class="math display">\[
Pr[s_t = j, s_{t-1} = i|t-1] = Pr[s_t = j|s_{t-1} = i]Pr[s_{t-1} =
i|t-1]
\]</span></p>
<p>for all <span class="math inline">\(i,j\)</span>, where <span class="math inline">\(Pr[s_t = j|s_{t-1} = i]\)</span> is the transition
probability.</p>
<p>The second step defines the conditional density based on the
prediction error decomposition. We first need the joint density of <span class="math inline">\(Y_t\)</span>, <span class="math inline">\(s_t\)</span>, and <span class="math inline">\(s_{t-1}\)</span> given by</p>
<p><span class="math display">\[
f(Y_t, s_t = j, s_{t-1} = i|t-1) = f(Y_t|s_t = j, s_{t-1} = i,
t-1)Pr[s_t = j, s_{t-1} = i|t-1]
\]</span> for all <span class="math inline">\(i,j\)</span>. The marginal
density of <span class="math inline">\(Y_t\)</span> is then</p>
<p><span class="math display">\[
f(Y_t|t-1) = \sum_{j=1}^S \sum_{i=1}^S f(Y_t, s_t = j, s_{t-1} = i|t-1)
Pr[s_t = j, s_{t-1} = i|t-1]
\]</span></p>
<p>where the conditional density of <span class="math inline">\(Y_t\)</span> is defined as</p>
<p><span class="math display">\[
f(Y_t|s_{t-1} = i, s_t = j, t-1) = (2\pi)^{-\frac{N}{2}}
|f_{t|t-1}^{(i,j)}|^{-\frac{1}{2}} exp\left( -\frac{1}{2}
\eta_{t|t-1}^{(i,j)\prime} f_{t|t-1}^{(i,j)\phantom{~}-1}
\eta_{t|t-1}^{(i,j)} \right)
\]</span></p>
<p>for all <span class="math inline">\(i,j\)</span>, where <span class="math inline">\(N\)</span> is the number of variables in <span class="math inline">\(Y_t\)</span>.</p>
<p>The third, and final, step is to update the probability terms by
using</p>
<p><span class="math display">\[
Pr[s_{t-1} = i, S_t = j|t] = \frac{f(s_{t-1} = i, s_t = j,
Y_t|t-1)}{f(Y_t|t-1)}
\]</span> for all <span class="math inline">\(i,j\)</span> to get</p>
<p><span class="math display">\[
Pr[s_t = j|t] = \sum_{i=1}^S Pr[s_{t-1} = i, s_t = j|t]
\]</span></p>
</div>
<div id="smoothing" class="section level2">
<h2>Smoothing</h2>
<p>Once the Kalman filter is applied to the data a smoothing procedure
can be applied in the backward direction to make a better inference of
the state components based on the entire data set. Unlike the filter,
the smoother does peak into the future to make an inference of the state
components at time <span class="math inline">\(t\)</span>. This
procedure for the basic Kalman filter consists of only two
equations.</p>
<p>The first equation updates the prediction of the state components
based on all the available information</p>
<p><span class="math display">\[
\beta_{t|T}^{(j,k)} = \beta_{t|t}^j + P_{t|t}^j F_k^{\prime} \left(
P_{t+1|t}^{(j,k)} \right)^{-1} \left( \beta_{t+1|T}^k -
\beta_{t+1|t}^{(j,k)} \right)
\]</span></p>
<p>The second equation updates the covariance matrix of the state
components based on all the available information</p>
<p>$$ P_{t|T}^{(j,k)} = P_{t|t}^j + P_{t|t}^j F_k^{} ( P_{t+1|t}^{(j,k)}
)^{-1} ( P_{t+1|T}^k - P_{t+1|t}^{(j,k)} ) ( P_{t+1|t}^{(j,k)} )^{-1}
F_k P_{t|t}^{j}</p>
<p>$$</p>
<p>However, the Kim filter adds two more equations. The first is the
joint probability of <span class="math inline">\(s_t = j\)</span> and
<span class="math inline">\(s_{t-1} = k\)</span> based on the full
information</p>
<p><span class="math display">\[
Pr[s_t = j, s_{t+1} = k|T] = \frac{Pr[s_{t+1} = k|T]Pr[s_t =
j|t]Pr[s_{t+1} = k|s_t = j]}{Pr[s_{t+1} = k|t]}
\]</span> and the second addition is</p>
<p><span class="math display">\[
Pr[s_t = j|T] = \sum_{k=1}^S pr[s_t = j, s_{t+1} = k|T]
\]</span></p>
<p>Finally, the Kim filter also requires the collapsing of terms in the
smoothing algorithm</p>
<p><span class="math display">\[
\beta_{t|T}^j = \frac{\sum_{k=1}^S Pr[s_t = j, s_{t+1} =
k|T]\beta_{t|T}^{(j,k)}}{Pr[s_t = j|T]}
\]</span></p>
<p>and</p>
<p><span class="math display">\[
P_{t|T}^j = \frac{\sum_{k=1}^S Pr[s_t = j, s_{t+1} = k|T]\left(
P_{t|T}^{(j,k)} + \left( \beta_{t|T}^j - \beta_{t|T}^{(i,j)}
\right)\left( \beta_{t|T}^j - \beta_{t|T}^{(i,j)} \right)^{\prime}
\right)}{Pr[s_t = j|T]}
\]</span></p>
<p>Finally, the smoothed value of the state components is given by</p>
<p><span class="math display">\[
\beta_{t|T} = \sum_{j = 1}^S Pr[s_t = j|T]\beta_{t|T}^j
\]</span></p>
</div>
<div id="example-stock-and-watson-markov-switching-dynamic-common-factor-model" class="section level2">
<h2>Example: Stock and Watson Markov Switching Dynamic Common Factor
Model</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co">#Note output does not work as expected anymore</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(kimfilter)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(maxLik)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="fu">data</span>(sw_dcf)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>data <span class="ot">=</span> sw_dcf[, <span class="fu">colnames</span>(sw_dcf) <span class="sc">!=</span> <span class="st">&quot;dcoinc&quot;</span>, with <span class="ot">=</span> F]</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>vars <span class="ot">=</span> <span class="fu">colnames</span>(data)[<span class="fu">colnames</span>(data) <span class="sc">!=</span> <span class="st">&quot;date&quot;</span>]</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="co">#State space model for the Stock and Watson Markov Switching Dynamic Common Factor model</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>msdcf_ssm <span class="ot">=</span> <span class="cf">function</span>(par, yt, <span class="at">n_states =</span> <span class="cn">NULL</span>){</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>  <span class="co">#Get the number of states</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>  n_states <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="fu">strsplit</span>(<span class="fu">names</span>(par)[<span class="fu">grepl</span>(<span class="st">&quot;p_&quot;</span>, <span class="fu">names</span>(par))], <span class="st">&quot;p_&quot;</span>), <span class="cf">function</span>(x){<span class="fu">substr</span>(x[<span class="dv">2</span>], <span class="dv">1</span>, <span class="dv">1</span>)}))))</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>  </span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>  <span class="co">#Get the parameters</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>  vars <span class="ot">=</span> <span class="fu">dimnames</span>(yt)[<span class="fu">which</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="fu">dimnames</span>(yt), <span class="cf">function</span>(x){<span class="sc">!</span><span class="fu">is.null</span>(x)})))][[<span class="dv">1</span>]]</span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>  phi <span class="ot">=</span> par[<span class="fu">grepl</span>(<span class="st">&quot;phi&quot;</span>, <span class="fu">names</span>(par))]</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>  <span class="fu">names</span>(phi) <span class="ot">=</span> <span class="fu">gsub</span>(<span class="st">&quot;phi&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="fu">names</span>(phi))</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>  gamma <span class="ot">=</span> par[<span class="fu">grepl</span>(<span class="st">&quot;gamma_&quot;</span>, <span class="fu">names</span>(par))]</span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>  <span class="fu">names</span>(gamma) <span class="ot">=</span> <span class="fu">gsub</span>(<span class="st">&quot;gamma_&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="fu">names</span>(gamma))</span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>  psi <span class="ot">=</span> par[<span class="fu">grepl</span>(<span class="st">&quot;psi_&quot;</span>, <span class="fu">names</span>(par))]</span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a>  <span class="fu">names</span>(psi) <span class="ot">=</span> <span class="fu">gsub</span>(<span class="st">&quot;psi_&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="fu">names</span>(psi))</span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>  sig <span class="ot">=</span> par[<span class="fu">grepl</span>(<span class="st">&quot;sigma_&quot;</span>, <span class="fu">names</span>(par))]</span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a>  <span class="fu">names</span>(sig) <span class="ot">=</span> <span class="fu">gsub</span>(<span class="st">&quot;sigma_&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="fu">names</span>(sig))</span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>  mu <span class="ot">=</span> par[<span class="fu">grepl</span>(<span class="st">&quot;mu&quot;</span>, <span class="fu">names</span>(par))]</span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a>  <span class="fu">names</span>(mu) <span class="ot">=</span> <span class="fu">gsub</span>(<span class="st">&quot;mu_&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="fu">names</span>(mu))</span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a>  pr <span class="ot">=</span> par[<span class="fu">grepl</span>(<span class="st">&quot;p_&quot;</span>, <span class="fu">names</span>(par))]</span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a>  <span class="fu">names</span>(pr) <span class="ot">=</span> <span class="fu">gsub</span>(<span class="st">&quot;p_&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="fu">names</span>(pr))</span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a>  states <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">substr</span>(<span class="fu">names</span>(pr), <span class="dv">1</span>, <span class="dv">1</span>)))</span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a>  </span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a>  <span class="co">#Steady state probabilities</span></span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a>  Pm <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> n_states, <span class="at">ncol =</span> n_states)</span>
<span id="cb1-34"><a href="#cb1-34" tabindex="-1"></a>  <span class="fu">rownames</span>(Pm) <span class="ot">=</span> <span class="fu">colnames</span>(Pm) <span class="ot">=</span> <span class="fu">unique</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="fu">names</span>(pr), <span class="cf">function</span>(x){<span class="fu">strsplit</span>(x, <span class="st">&quot;&quot;</span>)[[<span class="dv">1</span>]][<span class="dv">2</span>]})))</span>
<span id="cb1-35"><a href="#cb1-35" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="fu">names</span>(pr)){</span>
<span id="cb1-36"><a href="#cb1-36" tabindex="-1"></a>    Pm[<span class="fu">strsplit</span>(j, <span class="st">&quot;&quot;</span>)[[<span class="dv">1</span>]][<span class="dv">2</span>], <span class="fu">strsplit</span>(j, <span class="st">&quot;&quot;</span>)[[<span class="dv">1</span>]][<span class="dv">1</span>]] <span class="ot">=</span> pr[j]</span>
<span id="cb1-37"><a href="#cb1-37" tabindex="-1"></a>  }</span>
<span id="cb1-38"><a href="#cb1-38" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(Pm)){</span>
<span id="cb1-39"><a href="#cb1-39" tabindex="-1"></a>    Pm[<span class="fu">which</span>(<span class="fu">is.na</span>(Pm[, j])), j] <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(Pm[, j], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-40"><a href="#cb1-40" tabindex="-1"></a>  }</span>
<span id="cb1-41"><a href="#cb1-41" tabindex="-1"></a>  </span>
<span id="cb1-42"><a href="#cb1-42" tabindex="-1"></a>  <span class="co">#Build the transition matrix</span></span>
<span id="cb1-43"><a href="#cb1-43" tabindex="-1"></a>  phi_dim <span class="ot">=</span> <span class="fu">max</span>(<span class="fu">c</span>(<span class="fu">length</span>(phi)), <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">sapply</span>(<span class="fu">strsplit</span>(<span class="fu">names</span>(gamma), <span class="st">&quot;</span><span class="sc">\\</span><span class="st">.&quot;</span>), <span class="cf">function</span>(x){x[<span class="dv">2</span>]}))))</span>
<span id="cb1-44"><a href="#cb1-44" tabindex="-1"></a>  psi_dim <span class="ot">=</span> <span class="fu">sapply</span>(<span class="fu">unique</span>(<span class="fu">sapply</span>(<span class="fu">strsplit</span>(<span class="fu">names</span>(psi), <span class="st">&quot;</span><span class="sc">\\</span><span class="st">.&quot;</span>), <span class="cf">function</span>(x){x[<span class="dv">1</span>]})), <span class="cf">function</span>(x){</span>
<span id="cb1-45"><a href="#cb1-45" tabindex="-1"></a>    <span class="fu">max</span>(<span class="fu">as.numeric</span>(<span class="fu">sapply</span>(<span class="fu">strsplit</span>(<span class="fu">names</span>(psi)[<span class="fu">grepl</span>(<span class="fu">paste0</span>(<span class="st">&quot;^&quot;</span>, x), <span class="fu">names</span>(psi))], <span class="st">&quot;</span><span class="sc">\\</span><span class="st">.&quot;</span>), <span class="cf">function</span>(x){x[<span class="dv">2</span>]})))</span>
<span id="cb1-46"><a href="#cb1-46" tabindex="-1"></a>  })</span>
<span id="cb1-47"><a href="#cb1-47" tabindex="-1"></a>  Fm <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> phi_dim <span class="sc">+</span> <span class="fu">length</span>(psi), <span class="at">ncol =</span> phi_dim <span class="sc">+</span> <span class="fu">length</span>(psi), </span>
<span id="cb1-48"><a href="#cb1-48" tabindex="-1"></a>              <span class="at">dimnames =</span> <span class="fu">list</span>(</span>
<span id="cb1-49"><a href="#cb1-49" tabindex="-1"></a>                <span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">&quot;ct.&quot;</span>, <span class="dv">0</span><span class="sc">:</span>(phi_dim <span class="sc">-</span> <span class="dv">1</span>)), </span>
<span id="cb1-50"><a href="#cb1-50" tabindex="-1"></a>                  <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="fu">names</span>(psi_dim), <span class="cf">function</span>(x){<span class="fu">paste0</span>(<span class="st">&quot;e_&quot;</span>, x, <span class="st">&quot;.&quot;</span>, <span class="dv">0</span><span class="sc">:</span>(psi_dim[x] <span class="sc">-</span> <span class="dv">1</span>))}))),</span>
<span id="cb1-51"><a href="#cb1-51" tabindex="-1"></a>                <span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">&quot;ct.&quot;</span>, <span class="dv">1</span><span class="sc">:</span>phi_dim), </span>
<span id="cb1-52"><a href="#cb1-52" tabindex="-1"></a>                  <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="fu">names</span>(psi_dim), <span class="cf">function</span>(x){<span class="fu">paste0</span>(<span class="st">&quot;e_&quot;</span>, x, <span class="st">&quot;.&quot;</span>, <span class="dv">1</span><span class="sc">:</span>psi_dim[x])})))</span>
<span id="cb1-53"><a href="#cb1-53" tabindex="-1"></a>              ))</span>
<span id="cb1-54"><a href="#cb1-54" tabindex="-1"></a>  Fm[<span class="st">&quot;ct.0&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;ct.&quot;</span>, <span class="fu">names</span>(phi))] <span class="ot">=</span> phi</span>
<span id="cb1-55"><a href="#cb1-55" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(vars)){</span>
<span id="cb1-56"><a href="#cb1-56" tabindex="-1"></a>    Fm[<span class="fu">paste0</span>(<span class="st">&quot;e_&quot;</span>, i, <span class="st">&quot;.0&quot;</span>), </span>
<span id="cb1-57"><a href="#cb1-57" tabindex="-1"></a>       <span class="fu">paste0</span>(<span class="st">&quot;e_&quot;</span>, <span class="fu">names</span>(psi)[<span class="fu">grepl</span>(<span class="fu">paste0</span>(<span class="st">&quot;^&quot;</span>, i), <span class="fu">names</span>(psi))])] <span class="ot">=</span> psi[<span class="fu">grepl</span>(<span class="fu">paste0</span>(<span class="st">&quot;^&quot;</span>, i), <span class="fu">names</span>(psi))]</span>
<span id="cb1-58"><a href="#cb1-58" tabindex="-1"></a>  }</span>
<span id="cb1-59"><a href="#cb1-59" tabindex="-1"></a>  <span class="fu">diag</span>(Fm[<span class="fu">intersect</span>(<span class="fu">rownames</span>(Fm), <span class="fu">colnames</span>(Fm)), <span class="fu">intersect</span>(<span class="fu">rownames</span>(Fm), <span class="fu">colnames</span>(Fm))]) <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb1-60"><a href="#cb1-60" tabindex="-1"></a>  Fm <span class="ot">=</span> <span class="fu">array</span>(Fm, <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">nrow</span>(Fm), <span class="fu">ncol</span>(Fm), n_states), <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">rownames</span>(Fm), <span class="fu">colnames</span>(Fm), states))</span>
<span id="cb1-61"><a href="#cb1-61" tabindex="-1"></a>  </span>
<span id="cb1-62"><a href="#cb1-62" tabindex="-1"></a>  <span class="co">#Build the observation matrix</span></span>
<span id="cb1-63"><a href="#cb1-63" tabindex="-1"></a>  Hm <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(yt), <span class="at">ncol =</span> <span class="fu">nrow</span>(Fm), <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">rownames</span>(yt), <span class="fu">rownames</span>(Fm)))</span>
<span id="cb1-64"><a href="#cb1-64" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(vars)){</span>
<span id="cb1-65"><a href="#cb1-65" tabindex="-1"></a>    Hm[i, <span class="fu">paste0</span>(<span class="st">&quot;ct.&quot;</span>, <span class="fu">sapply</span>(<span class="fu">strsplit</span>(<span class="fu">names</span>(gamma)[<span class="fu">grepl</span>(<span class="fu">paste0</span>(<span class="st">&quot;^&quot;</span>, i), <span class="fu">names</span>(gamma))], <span class="st">&quot;</span><span class="sc">\\</span><span class="st">.&quot;</span>), <span class="cf">function</span>(x){x[<span class="dv">2</span>]}))] <span class="ot">=</span> </span>
<span id="cb1-66"><a href="#cb1-66" tabindex="-1"></a>      gamma[<span class="fu">grepl</span>(<span class="fu">paste0</span>(<span class="st">&quot;^&quot;</span>, i), <span class="fu">names</span>(gamma))]</span>
<span id="cb1-67"><a href="#cb1-67" tabindex="-1"></a>  }</span>
<span id="cb1-68"><a href="#cb1-68" tabindex="-1"></a>  <span class="fu">diag</span>(Hm[, <span class="fu">paste0</span>(<span class="st">&quot;e_&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(vars), <span class="st">&quot;.0&quot;</span>)]) <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb1-69"><a href="#cb1-69" tabindex="-1"></a>  Hm <span class="ot">=</span> <span class="fu">array</span>(Hm, <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">nrow</span>(Hm), <span class="fu">ncol</span>(Hm), n_states), <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">rownames</span>(Hm), <span class="fu">colnames</span>(Hm), states))</span>
<span id="cb1-70"><a href="#cb1-70" tabindex="-1"></a>  </span>
<span id="cb1-71"><a href="#cb1-71" tabindex="-1"></a>  <span class="co">#Build the state covariance matrix</span></span>
<span id="cb1-72"><a href="#cb1-72" tabindex="-1"></a>  <span class="co">#Set the dynamic common factor standard deviation to 1</span></span>
<span id="cb1-73"><a href="#cb1-73" tabindex="-1"></a>  Qm <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">ncol =</span> <span class="fu">ncol</span>(Fm), <span class="at">nrow =</span> <span class="fu">nrow</span>(Fm), <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">rownames</span>(Fm), <span class="fu">rownames</span>(Fm)))</span>
<span id="cb1-74"><a href="#cb1-74" tabindex="-1"></a>  Qm[<span class="st">&quot;ct.0&quot;</span>, <span class="st">&quot;ct.0&quot;</span>] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb1-75"><a href="#cb1-75" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(vars)){</span>
<span id="cb1-76"><a href="#cb1-76" tabindex="-1"></a>    Qm[<span class="fu">paste0</span>(<span class="st">&quot;e_&quot;</span>, i, <span class="st">&quot;.0&quot;</span>), <span class="fu">paste0</span>(<span class="st">&quot;e_&quot;</span>, i, <span class="st">&quot;.0&quot;</span>)] <span class="ot">=</span> sig[<span class="fu">names</span>(sig) <span class="sc">==</span> i]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb1-77"><a href="#cb1-77" tabindex="-1"></a>  } </span>
<span id="cb1-78"><a href="#cb1-78" tabindex="-1"></a>  Qm <span class="ot">=</span> <span class="fu">array</span>(Qm, <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">nrow</span>(Qm), <span class="fu">ncol</span>(Qm), n_states), <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">rownames</span>(Qm), <span class="fu">colnames</span>(Qm), states))</span>
<span id="cb1-79"><a href="#cb1-79" tabindex="-1"></a>  </span>
<span id="cb1-80"><a href="#cb1-80" tabindex="-1"></a>  <span class="co">#Build the observation equation covariance matrix</span></span>
<span id="cb1-81"><a href="#cb1-81" tabindex="-1"></a>  Rm <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">ncol =</span> <span class="fu">nrow</span>(Hm), <span class="at">nrow =</span> <span class="fu">nrow</span>(Hm), <span class="at">dimnames =</span> <span class="fu">list</span>(vars, vars))</span>
<span id="cb1-82"><a href="#cb1-82" tabindex="-1"></a>  Rm <span class="ot">=</span> <span class="fu">array</span>(Rm, <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">nrow</span>(Rm), <span class="fu">ncol</span>(Rm), n_states), <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">rownames</span>(Rm), <span class="fu">colnames</span>(Rm), states))</span>
<span id="cb1-83"><a href="#cb1-83" tabindex="-1"></a>  </span>
<span id="cb1-84"><a href="#cb1-84" tabindex="-1"></a>  <span class="co">#State intercept matrix: the Markov switching mean matrix</span></span>
<span id="cb1-85"><a href="#cb1-85" tabindex="-1"></a>  Dm <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(Fm), <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">rownames</span>(Fm), <span class="cn">NULL</span>))</span>
<span id="cb1-86"><a href="#cb1-86" tabindex="-1"></a>  Dm <span class="ot">=</span> <span class="fu">array</span>(Dm, <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">nrow</span>(Dm), <span class="dv">1</span>, n_states), <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">rownames</span>(Fm), <span class="cn">NULL</span>, states))</span>
<span id="cb1-87"><a href="#cb1-87" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">names</span>(mu)){</span>
<span id="cb1-88"><a href="#cb1-88" tabindex="-1"></a>    Dm[<span class="st">&quot;ct.0&quot;</span>, , i] <span class="ot">=</span> mu[i]</span>
<span id="cb1-89"><a href="#cb1-89" tabindex="-1"></a>  }</span>
<span id="cb1-90"><a href="#cb1-90" tabindex="-1"></a>  </span>
<span id="cb1-91"><a href="#cb1-91" tabindex="-1"></a>  <span class="co">#Observation equation intercept matrix</span></span>
<span id="cb1-92"><a href="#cb1-92" tabindex="-1"></a>  Am <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(Hm), <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb1-93"><a href="#cb1-93" tabindex="-1"></a>  Am <span class="ot">=</span> <span class="fu">array</span>(Am, <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">nrow</span>(Am), <span class="fu">ncol</span>(Am), n_states), <span class="at">dimnames =</span> <span class="fu">list</span>(vars, <span class="cn">NULL</span>, states))</span>
<span id="cb1-94"><a href="#cb1-94" tabindex="-1"></a>  </span>
<span id="cb1-95"><a href="#cb1-95" tabindex="-1"></a>  <span class="co">#Initialize the filter for each state</span></span>
<span id="cb1-96"><a href="#cb1-96" tabindex="-1"></a>  B0 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(Fm), <span class="dv">1</span>)</span>
<span id="cb1-97"><a href="#cb1-97" tabindex="-1"></a>  P0 <span class="ot">=</span> <span class="fu">diag</span>(<span class="fu">nrow</span>(Fm))</span>
<span id="cb1-98"><a href="#cb1-98" tabindex="-1"></a>  B0 <span class="ot">=</span> <span class="fu">array</span>(B0, <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">nrow</span>(B0), <span class="fu">ncol</span>(B0), n_states), <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">rownames</span>(Fm), <span class="cn">NULL</span>, states))</span>
<span id="cb1-99"><a href="#cb1-99" tabindex="-1"></a>  P0 <span class="ot">=</span> <span class="fu">array</span>(P0, <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">nrow</span>(P0), <span class="fu">ncol</span>(P0), n_states), <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">rownames</span>(B0), <span class="fu">colnames</span>(B0), states))</span>
<span id="cb1-100"><a href="#cb1-100" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> states){</span>
<span id="cb1-101"><a href="#cb1-101" tabindex="-1"></a>    B0[,,i] <span class="ot">=</span> <span class="fu">solve</span>(<span class="fu">diag</span>(<span class="fu">ncol</span>(Fm)) <span class="sc">-</span> Fm[,,i]) <span class="sc">%*%</span> Dm[,,i]</span>
<span id="cb1-102"><a href="#cb1-102" tabindex="-1"></a>    VecP_ll <span class="ot">=</span> <span class="fu">solve</span>(<span class="fu">diag</span>(<span class="fu">prod</span>(<span class="fu">dim</span>(Fm[,,i]))) <span class="sc">-</span> <span class="fu">kronecker</span>(Fm[,,i], Fm[,,i])) <span class="sc">%*%</span> <span class="fu">matrix</span>(<span class="fu">as.vector</span>(Qm[,,i]), <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb1-103"><a href="#cb1-103" tabindex="-1"></a>    P0[,,i] <span class="ot">=</span> <span class="fu">matrix</span>(VecP_ll[, <span class="dv">1</span>], <span class="at">ncol =</span> <span class="fu">ncol</span>(Fm))</span>
<span id="cb1-104"><a href="#cb1-104" tabindex="-1"></a>  }</span>
<span id="cb1-105"><a href="#cb1-105" tabindex="-1"></a> </span>
<span id="cb1-106"><a href="#cb1-106" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">B0 =</span> B0, <span class="at">P0 =</span> P0, <span class="at">Am =</span> Am, <span class="at">Dm =</span> Dm, <span class="at">Hm =</span> Hm, <span class="at">Fm =</span> Fm, <span class="at">Qm =</span> Qm, <span class="at">Rm =</span> Rm, <span class="at">Pm =</span> Pm))</span>
<span id="cb1-107"><a href="#cb1-107" tabindex="-1"></a>}</span>
<span id="cb1-108"><a href="#cb1-108" tabindex="-1"></a></span>
<span id="cb1-109"><a href="#cb1-109" tabindex="-1"></a><span class="co">#Log the data</span></span>
<span id="cb1-110"><a href="#cb1-110" tabindex="-1"></a>data.log <span class="ot">=</span> <span class="fu">copy</span>(data)</span>
<span id="cb1-111"><a href="#cb1-111" tabindex="-1"></a>data.log[, <span class="fu">c</span>(vars) <span class="sc">:=</span> <span class="fu">lapply</span>(.SD, log), .SDcols <span class="ot">=</span> <span class="fu">c</span>(vars)]</span>
<span id="cb1-112"><a href="#cb1-112" tabindex="-1"></a></span>
<span id="cb1-113"><a href="#cb1-113" tabindex="-1"></a><span class="co">#Difference the data</span></span>
<span id="cb1-114"><a href="#cb1-114" tabindex="-1"></a>data.logd <span class="ot">=</span> <span class="fu">copy</span>(data.log)</span>
<span id="cb1-115"><a href="#cb1-115" tabindex="-1"></a>data.logd[, <span class="fu">c</span>(vars) <span class="sc">:=</span> <span class="fu">lapply</span>(.SD, <span class="cf">function</span>(x){</span>
<span id="cb1-116"><a href="#cb1-116" tabindex="-1"></a>  x <span class="sc">-</span> <span class="fu">shift</span>(x, <span class="at">type =</span> <span class="st">&quot;lag&quot;</span>, <span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb1-117"><a href="#cb1-117" tabindex="-1"></a>}), .SDcols <span class="ot">=</span> <span class="fu">c</span>(vars)]</span>
<span id="cb1-118"><a href="#cb1-118" tabindex="-1"></a></span>
<span id="cb1-119"><a href="#cb1-119" tabindex="-1"></a><span class="co">#Center the data</span></span>
<span id="cb1-120"><a href="#cb1-120" tabindex="-1"></a>data.logds <span class="ot">=</span> <span class="fu">copy</span>(data.logd)</span>
<span id="cb1-121"><a href="#cb1-121" tabindex="-1"></a>data.logds[, <span class="fu">c</span>(vars) <span class="sc">:=</span> <span class="fu">lapply</span>(.SD, scale, <span class="at">scale =</span> <span class="cn">FALSE</span>), .SDcols <span class="ot">=</span> <span class="fu">c</span>(vars)]</span>
<span id="cb1-122"><a href="#cb1-122" tabindex="-1"></a></span>
<span id="cb1-123"><a href="#cb1-123" tabindex="-1"></a><span class="co">#Transpose the data</span></span>
<span id="cb1-124"><a href="#cb1-124" tabindex="-1"></a>yt <span class="ot">=</span> <span class="fu">t</span>(data.logds[, <span class="fu">c</span>(vars), <span class="at">with =</span> F])</span>
<span id="cb1-125"><a href="#cb1-125" tabindex="-1"></a></span>
<span id="cb1-126"><a href="#cb1-126" tabindex="-1"></a><span class="co">#Set the initial values</span></span>
<span id="cb1-127"><a href="#cb1-127" tabindex="-1"></a>init <span class="ot">=</span> <span class="fu">c</span>(<span class="at">phi1 =</span> <span class="fl">0.8760</span>, <span class="at">phi2 =</span> <span class="sc">-</span><span class="fl">0.2171</span>, </span>
<span id="cb1-128"><a href="#cb1-128" tabindex="-1"></a>         <span class="at">mu_u =</span> <span class="fl">0.2802</span>, <span class="at">mu_d =</span> <span class="sc">-</span><span class="fl">1.5700</span>,</span>
<span id="cb1-129"><a href="#cb1-129" tabindex="-1"></a>         <span class="at">p_dd =</span> <span class="fl">0.8406</span>, <span class="at">p_uu =</span> <span class="fl">0.9696</span>,</span>
<span id="cb1-130"><a href="#cb1-130" tabindex="-1"></a>         <span class="at">psi_1.1 =</span> <span class="fl">0.0364</span>, <span class="at">psi_1.2 =</span> <span class="sc">-</span><span class="fl">0.0008</span>,</span>
<span id="cb1-131"><a href="#cb1-131" tabindex="-1"></a>         <span class="at">psi_2.1 =</span> <span class="sc">-</span><span class="fl">0.2965</span>, <span class="at">psi_2.2 =</span> <span class="sc">-</span><span class="fl">0.0657</span>,</span>
<span id="cb1-132"><a href="#cb1-132" tabindex="-1"></a>         <span class="at">psi_3.1 =</span> <span class="sc">-</span><span class="fl">0.3959</span>, <span class="at">psi_3.2 =</span> <span class="sc">-</span><span class="fl">0.1903</span>,</span>
<span id="cb1-133"><a href="#cb1-133" tabindex="-1"></a>         <span class="at">psi_4.1 =</span> <span class="sc">-</span><span class="fl">0.2436</span>, <span class="at">psi_4.2 =</span> <span class="fl">0.1281</span>,</span>
<span id="cb1-134"><a href="#cb1-134" tabindex="-1"></a>         <span class="at">gamma_1.0 =</span> <span class="fl">0.0058</span>, <span class="at">gamma_1.1 =</span> <span class="sc">-</span><span class="fl">0.0033</span>,</span>
<span id="cb1-135"><a href="#cb1-135" tabindex="-1"></a>         <span class="at">gamma_2.0 =</span> <span class="fl">0.0011</span>,  </span>
<span id="cb1-136"><a href="#cb1-136" tabindex="-1"></a>         <span class="at">gamma_3.0 =</span> <span class="fl">0.0051</span>, <span class="at">gamma_3.1 =</span> <span class="sc">-</span><span class="fl">0.0033</span> , </span>
<span id="cb1-137"><a href="#cb1-137" tabindex="-1"></a>         <span class="at">gamma_4.0 =</span> <span class="fl">0.0012</span>, <span class="at">gamma_4.1 =</span> <span class="sc">-</span><span class="fl">0.0005</span>, <span class="at">gamma_4.2 =</span> <span class="fl">0.0001</span>, <span class="at">gamma_4.3 =</span> <span class="fl">0.0002</span>,</span>
<span id="cb1-138"><a href="#cb1-138" tabindex="-1"></a>         <span class="at">sigma_1 =</span> <span class="fl">0.0048</span>, <span class="at">sigma_2 =</span> <span class="fl">0.0057</span>, <span class="at">sigma_3 =</span> <span class="fl">0.0078</span>, <span class="at">sigma_4 =</span> <span class="fl">0.0013</span>)</span>
<span id="cb1-139"><a href="#cb1-139" tabindex="-1"></a></span>
<span id="cb1-140"><a href="#cb1-140" tabindex="-1"></a><span class="co">#Set the constraints</span></span>
<span id="cb1-141"><a href="#cb1-141" tabindex="-1"></a>ineqA <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">20</span>, <span class="at">ncol =</span> <span class="fu">length</span>(init), <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="cn">NULL</span>, <span class="fu">names</span>(init)))</span>
<span id="cb1-142"><a href="#cb1-142" tabindex="-1"></a><span class="co">#Stationarity constraints</span></span>
<span id="cb1-143"><a href="#cb1-143" tabindex="-1"></a>ineqA[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="fu">c</span>(<span class="st">&quot;phi1&quot;</span>, <span class="st">&quot;phi2&quot;</span>)] <span class="ot">=</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb1-144"><a href="#cb1-144" tabindex="-1"></a>ineqA[<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>), <span class="fu">grepl</span>(<span class="st">&quot;psi_1&quot;</span>, <span class="fu">colnames</span>(ineqA))] <span class="ot">=</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb1-145"><a href="#cb1-145" tabindex="-1"></a>ineqA[<span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">6</span>), <span class="fu">grepl</span>(<span class="st">&quot;psi_2&quot;</span>, <span class="fu">colnames</span>(ineqA))] <span class="ot">=</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb1-146"><a href="#cb1-146" tabindex="-1"></a>ineqA[<span class="fu">c</span>(<span class="dv">7</span>, <span class="dv">8</span>), <span class="fu">grepl</span>(<span class="st">&quot;psi_3&quot;</span>, <span class="fu">colnames</span>(ineqA))] <span class="ot">=</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb1-147"><a href="#cb1-147" tabindex="-1"></a>ineqA[<span class="fu">c</span>(<span class="dv">9</span>, <span class="dv">10</span>), <span class="fu">grepl</span>(<span class="st">&quot;psi_4&quot;</span>, <span class="fu">colnames</span>(ineqA))] <span class="ot">=</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb1-148"><a href="#cb1-148" tabindex="-1"></a><span class="co">#Non-negativity constraints</span></span>
<span id="cb1-149"><a href="#cb1-149" tabindex="-1"></a><span class="fu">diag</span>(ineqA[<span class="fu">c</span>(<span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">13</span>, <span class="dv">14</span>), <span class="fu">grepl</span>(<span class="st">&quot;sigma_&quot;</span>, <span class="fu">colnames</span>(ineqA))]) <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb1-150"><a href="#cb1-150" tabindex="-1"></a>ineqA[<span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">16</span>), <span class="st">&quot;p_dd&quot;</span>] <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb1-151"><a href="#cb1-151" tabindex="-1"></a>ineqA[<span class="fu">c</span>(<span class="dv">17</span>, <span class="dv">18</span>), <span class="st">&quot;p_uu&quot;</span>] <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb1-152"><a href="#cb1-152" tabindex="-1"></a><span class="co">#Up/down states must be positive/negative</span></span>
<span id="cb1-153"><a href="#cb1-153" tabindex="-1"></a>ineqA[<span class="dv">19</span>, <span class="st">&quot;mu_u&quot;</span>] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb1-154"><a href="#cb1-154" tabindex="-1"></a>ineqA[<span class="dv">20</span>, <span class="st">&quot;mu_d&quot;</span>] <span class="ot">=</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb1-155"><a href="#cb1-155" tabindex="-1"></a>ineqB <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">10</span>), </span>
<span id="cb1-156"><a href="#cb1-156" tabindex="-1"></a>                 <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>), </span>
<span id="cb1-157"><a href="#cb1-157" tabindex="-1"></a>                 <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb1-158"><a href="#cb1-158" tabindex="-1"></a>                 <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb1-159"><a href="#cb1-159" tabindex="-1"></a>                 <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">2</span>)), <span class="at">nrow =</span> <span class="fu">nrow</span>(ineqA), <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb1-160"><a href="#cb1-160" tabindex="-1"></a></span>
<span id="cb1-161"><a href="#cb1-161" tabindex="-1"></a><span class="co">#Define the objective function</span></span>
<span id="cb1-162"><a href="#cb1-162" tabindex="-1"></a>objective <span class="ot">=</span> <span class="cf">function</span>(par, yt){</span>
<span id="cb1-163"><a href="#cb1-163" tabindex="-1"></a>  ssm <span class="ot">=</span> <span class="fu">msdcf_ssm</span>(par, yt)</span>
<span id="cb1-164"><a href="#cb1-164" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">kim_filter</span>(ssm, yt, <span class="at">smooth =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>lnl)</span>
<span id="cb1-165"><a href="#cb1-165" tabindex="-1"></a>}</span>
<span id="cb1-166"><a href="#cb1-166" tabindex="-1"></a></span>
<span id="cb1-167"><a href="#cb1-167" tabindex="-1"></a><span class="co">#Solve the model</span></span>
<span id="cb1-168"><a href="#cb1-168" tabindex="-1"></a>solve <span class="ot">=</span> <span class="fu">maxLik</span>(<span class="at">logLik =</span> objective, <span class="at">start =</span> init, <span class="at">method =</span> <span class="st">&quot;BFGS&quot;</span>, </span>
<span id="cb1-169"><a href="#cb1-169" tabindex="-1"></a>               <span class="at">finalHessian =</span> <span class="cn">FALSE</span>, <span class="at">hess =</span> <span class="cn">NULL</span>, </span>
<span id="cb1-170"><a href="#cb1-170" tabindex="-1"></a>               <span class="at">control =</span> <span class="fu">list</span>(<span class="at">printLevel =</span> <span class="dv">2</span>, <span class="at">iterlim =</span> <span class="dv">10000</span>), </span>
<span id="cb1-171"><a href="#cb1-171" tabindex="-1"></a>               <span class="at">constraints =</span> <span class="fu">list</span>(<span class="at">ineqA =</span> ineqA, <span class="at">ineqB =</span> ineqB), </span>
<span id="cb1-172"><a href="#cb1-172" tabindex="-1"></a>               <span class="at">yt =</span> yt)</span>
<span id="cb1-173"><a href="#cb1-173" tabindex="-1"></a></span>
<span id="cb1-174"><a href="#cb1-174" tabindex="-1"></a><span class="co">#Get the estimated state space model</span></span>
<span id="cb1-175"><a href="#cb1-175" tabindex="-1"></a>ssm <span class="ot">=</span> <span class="fu">msdcf_ssm</span>(solve<span class="sc">$</span>estimate, yt)</span>
<span id="cb1-176"><a href="#cb1-176" tabindex="-1"></a></span>
<span id="cb1-177"><a href="#cb1-177" tabindex="-1"></a><span class="co">#Get the column means and standard deviations</span></span>
<span id="cb1-178"><a href="#cb1-178" tabindex="-1"></a>M <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(data.logd[, <span class="fu">lapply</span>(.SD, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.SDcols =</span> <span class="fu">c</span>(vars)]), </span>
<span id="cb1-179"><a href="#cb1-179" tabindex="-1"></a>               <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">dimnames =</span> <span class="fu">list</span>(vars, <span class="cn">NULL</span>))</span>
<span id="cb1-180"><a href="#cb1-180" tabindex="-1"></a></span>
<span id="cb1-181"><a href="#cb1-181" tabindex="-1"></a><span class="co">#Get the steady state coefficient matrices</span></span>
<span id="cb1-182"><a href="#cb1-182" tabindex="-1"></a>Pm <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">ss_prob</span>(ssm[[<span class="st">&quot;Pm&quot;</span>]]), <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">rownames</span>(ssm[[<span class="st">&quot;Pm&quot;</span>]]), <span class="cn">NULL</span>))</span>
<span id="cb1-183"><a href="#cb1-183" tabindex="-1"></a>Hm <span class="ot">=</span> <span class="fu">Reduce</span>(<span class="st">&quot;+&quot;</span>, <span class="fu">lapply</span>(<span class="fu">dimnames</span>(ssm[[<span class="st">&quot;Hm&quot;</span>]])[[<span class="dv">3</span>]], <span class="cf">function</span>(x){</span>
<span id="cb1-184"><a href="#cb1-184" tabindex="-1"></a>  Pm[x, ]<span class="sc">*</span>ssm[[<span class="st">&quot;Hm&quot;</span>]][,, x]</span>
<span id="cb1-185"><a href="#cb1-185" tabindex="-1"></a>}))</span>
<span id="cb1-186"><a href="#cb1-186" tabindex="-1"></a>Fm <span class="ot">=</span> <span class="fu">Reduce</span>(<span class="st">&quot;+&quot;</span>, <span class="fu">lapply</span>(<span class="fu">dimnames</span>(ssm[[<span class="st">&quot;Fm&quot;</span>]])[[<span class="dv">3</span>]], <span class="cf">function</span>(x){</span>
<span id="cb1-187"><a href="#cb1-187" tabindex="-1"></a>  Pm[x, ]<span class="sc">*</span>ssm[[<span class="st">&quot;Fm&quot;</span>]][,, x]</span>
<span id="cb1-188"><a href="#cb1-188" tabindex="-1"></a>}))</span>
<span id="cb1-189"><a href="#cb1-189" tabindex="-1"></a></span>
<span id="cb1-190"><a href="#cb1-190" tabindex="-1"></a><span class="co">#Final K_t is approximation to steady state K</span></span>
<span id="cb1-191"><a href="#cb1-191" tabindex="-1"></a>filter <span class="ot">=</span> <span class="fu">kim_filter</span>(ssm, yt, <span class="at">smooth =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-192"><a href="#cb1-192" tabindex="-1"></a>K <span class="ot">=</span> filter<span class="sc">$</span>K_t[,, <span class="fu">dim</span>(filter<span class="sc">$</span>K_t)[<span class="dv">3</span>]]</span>
<span id="cb1-193"><a href="#cb1-193" tabindex="-1"></a>W <span class="ot">=</span> <span class="fu">solve</span>(<span class="fu">diag</span>(<span class="fu">nrow</span>(K)) <span class="sc">-</span> (<span class="fu">diag</span>(<span class="fu">nrow</span>(K)) <span class="sc">-</span> K <span class="sc">%*%</span> Hm) <span class="sc">%*%</span> Fm) <span class="sc">%*%</span> K</span>
<span id="cb1-194"><a href="#cb1-194" tabindex="-1"></a>d <span class="ot">=</span> (W <span class="sc">%*%</span> M)[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb1-195"><a href="#cb1-195" tabindex="-1"></a></span>
<span id="cb1-196"><a href="#cb1-196" tabindex="-1"></a><span class="co">#Get the intercept terms</span></span>
<span id="cb1-197"><a href="#cb1-197" tabindex="-1"></a>gamma <span class="ot">=</span> Hm[, <span class="fu">grepl</span>(<span class="st">&quot;ct&quot;</span>, <span class="fu">colnames</span>(Hm))]</span>
<span id="cb1-198"><a href="#cb1-198" tabindex="-1"></a>D <span class="ot">=</span> M <span class="sc">-</span> gamma <span class="sc">%*%</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(d, <span class="fu">ncol</span>(gamma)))</span>
<span id="cb1-199"><a href="#cb1-199" tabindex="-1"></a></span>
<span id="cb1-200"><a href="#cb1-200" tabindex="-1"></a><span class="co">#Initialize first element of the dynamic common factor</span></span>
<span id="cb1-201"><a href="#cb1-201" tabindex="-1"></a>Y1 <span class="ot">=</span> <span class="fu">t</span>(data.log[, <span class="fu">c</span>(vars), <span class="at">with =</span> F][<span class="dv">1</span>, ])</span>
<span id="cb1-202"><a href="#cb1-202" tabindex="-1"></a>initC <span class="ot">=</span> <span class="cf">function</span>(par){</span>
<span id="cb1-203"><a href="#cb1-203" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sum</span>((Y1 <span class="sc">-</span> D <span class="sc">-</span> gamma <span class="sc">%*%</span> par)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb1-204"><a href="#cb1-204" tabindex="-1"></a>}</span>
<span id="cb1-205"><a href="#cb1-205" tabindex="-1"></a>C10 <span class="ot">=</span> <span class="fu">optim</span>(<span class="at">par =</span> Y1, <span class="at">fn =</span> initC, <span class="at">method =</span> <span class="st">&quot;BFGS&quot;</span>, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">trace =</span> <span class="cn">FALSE</span>))<span class="sc">$</span>par[<span class="dv">1</span>]</span>
<span id="cb1-206"><a href="#cb1-206" tabindex="-1"></a>Ctt <span class="ot">=</span> <span class="fu">rep</span>(C10, <span class="fu">ncol</span>(yt))</span>
<span id="cb1-207"><a href="#cb1-207" tabindex="-1"></a></span>
<span id="cb1-208"><a href="#cb1-208" tabindex="-1"></a><span class="co">#Build the rest of the level of the dynamic common factor</span></span>
<span id="cb1-209"><a href="#cb1-209" tabindex="-1"></a>ctt <span class="ot">=</span> filter<span class="sc">$</span>B_tt[<span class="fu">which</span>(<span class="fu">rownames</span>(Fm) <span class="sc">==</span> <span class="st">&quot;ct.0&quot;</span>), ]</span>
<span id="cb1-210"><a href="#cb1-210" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(Ctt)){</span>
<span id="cb1-211"><a href="#cb1-211" tabindex="-1"></a>  Ctt[j] <span class="ot">=</span> ctt[j] <span class="sc">+</span> Ctt[j <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fu">c</span>(d)</span>
<span id="cb1-212"><a href="#cb1-212" tabindex="-1"></a>}</span>
<span id="cb1-213"><a href="#cb1-213" tabindex="-1"></a>Ctt <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">date =</span> data<span class="sc">$</span>date, <span class="at">dcf =</span> Ctt, <span class="at">d.dcf =</span> ctt)</span>
<span id="cb1-214"><a href="#cb1-214" tabindex="-1"></a>prob <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">date =</span> data<span class="sc">$</span>date, <span class="fu">data.table</span>(filter<span class="sc">$</span>Pr_tt))</span>
<span id="cb1-215"><a href="#cb1-215" tabindex="-1"></a><span class="fu">colnames</span>(prob) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;pr_&quot;</span>, <span class="fu">dimnames</span>(ssm<span class="sc">$</span>Dm)[[<span class="dv">3</span>]]))</span>
<span id="cb1-216"><a href="#cb1-216" tabindex="-1"></a>uc <span class="ot">=</span> <span class="fu">merge</span>(Ctt, prob, <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-217"><a href="#cb1-217" tabindex="-1"></a></span>
<span id="cb1-218"><a href="#cb1-218" tabindex="-1"></a><span class="co">#Plot the outputs</span></span>
<span id="cb1-219"><a href="#cb1-219" tabindex="-1"></a>g1 <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="fu">melt</span>(data.log, <span class="at">id.vars =</span> <span class="st">&quot;date&quot;</span>)[, <span class="st">&quot;value&quot;</span> <span class="sc">:=</span> <span class="fu">scale</span>(value), <span class="at">by =</span> <span class="st">&quot;variable&quot;</span>]) <span class="sc">+</span> </span>
<span id="cb1-220"><a href="#cb1-220" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Data&quot;</span>, <span class="at">subtitle =</span> <span class="st">&quot;Log Levels (Rescaled)&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-221"><a href="#cb1-221" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">name =</span> <span class="st">&quot;Value&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-222"><a href="#cb1-222" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-223"><a href="#cb1-223" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">color =</span> variable)) <span class="sc">+</span> </span>
<span id="cb1-224"><a href="#cb1-224" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>))</span>
<span id="cb1-225"><a href="#cb1-225" tabindex="-1"></a></span>
<span id="cb1-226"><a href="#cb1-226" tabindex="-1"></a>g2 <span class="ot">=</span> <span class="fu">ggplot</span>( <span class="fu">melt</span>(data.logds, <span class="at">id.vars =</span> <span class="st">&quot;date&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb1-227"><a href="#cb1-227" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Data&quot;</span>, <span class="at">subtitle =</span> <span class="st">&quot;Log Differenced &amp; Standardized&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-228"><a href="#cb1-228" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">name =</span> <span class="st">&quot;Value&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-229"><a href="#cb1-229" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-230"><a href="#cb1-230" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-231"><a href="#cb1-231" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">color =</span> variable)) <span class="sc">+</span> </span>
<span id="cb1-232"><a href="#cb1-232" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>))</span>
<span id="cb1-233"><a href="#cb1-233" tabindex="-1"></a></span>
<span id="cb1-234"><a href="#cb1-234" tabindex="-1"></a>toplot3 <span class="ot">=</span> <span class="fu">melt</span>(uc, <span class="at">id.vars =</span> <span class="st">&quot;date&quot;</span>)</span>
<span id="cb1-235"><a href="#cb1-235" tabindex="-1"></a>d_range1 <span class="ot">=</span> <span class="fu">range</span>(toplot3[variable <span class="sc">==</span> <span class="st">&quot;dcf&quot;</span>, ]<span class="sc">$</span>value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-236"><a href="#cb1-236" tabindex="-1"></a>p_range1 <span class="ot">=</span> <span class="fu">range</span>(toplot3[variable <span class="sc">%in%</span> <span class="fu">colnames</span>(uc)[<span class="fu">grepl</span>(<span class="st">&quot;pr_&quot;</span>, <span class="fu">colnames</span>(uc))], ]<span class="sc">$</span>value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-237"><a href="#cb1-237" tabindex="-1"></a>toplot3[variable <span class="sc">%in%</span> <span class="fu">colnames</span>(uc)[<span class="fu">grepl</span>(<span class="st">&quot;pr_&quot;</span>, <span class="fu">colnames</span>(uc))], <span class="st">&quot;value&quot;</span> <span class="sc">:=</span> (value <span class="sc">-</span> p_range1[<span class="dv">1</span>])<span class="sc">/</span><span class="fu">diff</span>(p_range1) <span class="sc">*</span> <span class="fu">diff</span>(d_range1) <span class="sc">+</span> d_range1[<span class="dv">1</span>], by <span class="ot">=</span> <span class="st">&quot;variable&quot;</span>]</span>
<span id="cb1-238"><a href="#cb1-238" tabindex="-1"></a>g3 <span class="ot">=</span> <span class="fu">ggplot</span>() <span class="sc">+</span>  </span>
<span id="cb1-239"><a href="#cb1-239" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Dynamic Common Factor&quot;</span>, <span class="at">subtitle =</span> <span class="st">&quot;Levels&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-240"><a href="#cb1-240" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb1-241"><a href="#cb1-241" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-242"><a href="#cb1-242" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> toplot3[variable <span class="sc">==</span> <span class="st">&quot;dcf&quot;</span>, ], </span>
<span id="cb1-243"><a href="#cb1-243" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">color =</span> variable)) <span class="sc">+</span> </span>
<span id="cb1-244"><a href="#cb1-244" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-245"><a href="#cb1-245" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>), <span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>)) <span class="sc">+</span> </span>
<span id="cb1-246"><a href="#cb1-246" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-247"><a href="#cb1-247" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">name =</span> <span class="st">&quot;Value&quot;</span>, <span class="at">limits =</span> <span class="fu">range</span>(toplot3[variable <span class="sc">==</span> <span class="st">&quot;dcf&quot;</span>, ]<span class="sc">$</span>value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb1-248"><a href="#cb1-248" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="at">name =</span> <span class="st">&quot;Probability&quot;</span>, <span class="sc">~</span>((. <span class="sc">-</span> d_range1[<span class="dv">1</span>])<span class="sc">/</span><span class="fu">diff</span>(d_range1) <span class="sc">*</span> <span class="fu">diff</span>(p_range1) <span class="sc">+</span> p_range1[<span class="dv">1</span>]) <span class="sc">*</span> <span class="dv">100</span>)) <span class="sc">+</span> </span>
<span id="cb1-249"><a href="#cb1-249" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> toplot3[variable <span class="sc">%in%</span> <span class="st">&quot;pr_d&quot;</span>, ], </span>
<span id="cb1-250"><a href="#cb1-250" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">ymin =</span> d_range1[<span class="dv">1</span>], <span class="at">ymax =</span> value, <span class="at">group =</span> variable, <span class="at">fill =</span> variable), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb1-251"><a href="#cb1-251" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;green&quot;</span>))</span>
<span id="cb1-252"><a href="#cb1-252" tabindex="-1"></a></span>
<span id="cb1-253"><a href="#cb1-253" tabindex="-1"></a>toplot4 <span class="ot">=</span> <span class="fu">melt</span>(uc, <span class="at">id.vars =</span> <span class="st">&quot;date&quot;</span>)</span>
<span id="cb1-254"><a href="#cb1-254" tabindex="-1"></a>d_range2 <span class="ot">=</span> <span class="fu">range</span>(toplot4[variable <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;d.dcf&quot;</span>), ]<span class="sc">$</span>value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-255"><a href="#cb1-255" tabindex="-1"></a>p_range2 <span class="ot">=</span> <span class="fu">range</span>(toplot4[variable <span class="sc">%in%</span> <span class="fu">colnames</span>(uc)[<span class="fu">grepl</span>(<span class="st">&quot;pr_&quot;</span>, <span class="fu">colnames</span>(uc))], ]<span class="sc">$</span>value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-256"><a href="#cb1-256" tabindex="-1"></a>toplot4[variable <span class="sc">%in%</span> <span class="fu">colnames</span>(uc)[<span class="fu">grepl</span>(<span class="st">&quot;pr_&quot;</span>, <span class="fu">colnames</span>(uc))], <span class="st">&quot;value&quot;</span> <span class="sc">:=</span> (value <span class="sc">-</span> p_range2[<span class="dv">1</span>])<span class="sc">/</span><span class="fu">diff</span>(p_range2) <span class="sc">*</span> <span class="fu">diff</span>(d_range2) <span class="sc">+</span> d_range2[<span class="dv">1</span>], by <span class="ot">=</span> <span class="st">&quot;variable&quot;</span>]</span>
<span id="cb1-257"><a href="#cb1-257" tabindex="-1"></a>g4 <span class="ot">=</span> <span class="fu">ggplot</span>() <span class="sc">+</span>  </span>
<span id="cb1-258"><a href="#cb1-258" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Dynamic Common Factor&quot;</span>, <span class="at">subtitle =</span> <span class="st">&quot;Differenced&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-259"><a href="#cb1-259" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb1-260"><a href="#cb1-260" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-261"><a href="#cb1-261" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> toplot4[variable <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;d.dcf&quot;</span>), ], </span>
<span id="cb1-262"><a href="#cb1-262" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">color =</span> variable)) <span class="sc">+</span> </span>
<span id="cb1-263"><a href="#cb1-263" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-264"><a href="#cb1-264" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>), <span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>)) <span class="sc">+</span> </span>
<span id="cb1-265"><a href="#cb1-265" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-266"><a href="#cb1-266" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">name =</span> <span class="st">&quot;Value&quot;</span>, <span class="at">limits =</span> <span class="fu">range</span>(toplot4[variable <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;d.dcf&quot;</span>), ]<span class="sc">$</span>value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb1-267"><a href="#cb1-267" tabindex="-1"></a>                               <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="at">name =</span> <span class="st">&quot;Probability&quot;</span>, <span class="sc">~</span>((. <span class="sc">-</span> d_range2[<span class="dv">1</span>])<span class="sc">/</span><span class="fu">diff</span>(d_range2) <span class="sc">*</span> <span class="fu">diff</span>(p_range2) <span class="sc">+</span> p_range2[<span class="dv">1</span>]) <span class="sc">*</span> <span class="dv">100</span>)) <span class="sc">+</span> </span>
<span id="cb1-268"><a href="#cb1-268" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> toplot4[variable <span class="sc">%in%</span> <span class="st">&quot;pr_d&quot;</span>, ], </span>
<span id="cb1-269"><a href="#cb1-269" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">ymin =</span> d_range2[<span class="dv">1</span>], <span class="at">ymax =</span> value, <span class="at">group =</span> variable, <span class="at">fill =</span> variable), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb1-270"><a href="#cb1-270" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;green&quot;</span>))</span>
<span id="cb1-271"><a href="#cb1-271" tabindex="-1"></a></span>
<span id="cb1-272"><a href="#cb1-272" tabindex="-1"></a><span class="fu">grid.arrange</span>(g1, g2, g3, g4, <span class="at">layout_matrix =</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">4</span>), <span class="at">nrow =</span> <span class="dv">2</span>))</span></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
